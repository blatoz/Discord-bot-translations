<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="/css/polaris.css?v=3" type="text/css" rel="stylesheet">
    <link rel="icon" href="/assets/polaris.svg">
    <title>Polaris</title>

    <meta property="og:title" content="Ghosty | Szint Rendszer">
    <meta property="og:description" content="Egy nyílt forráskódú XP bot">
    <meta property="og:type" content="website">
    <meta name="theme-color" content="#00ff80">
    <meta name="twitter:card" content="summary">
    <meta name="robots" content="noindex">
</head>
<body>

    <h2 style="margin-top: 75px; width: 100%; position: absolute;" class="middleflex" id="loading">Betöltés...</h2>

    <div id="everything" style="display: none; width: 1600px">

    <div id="sidebar">
        <div tabindex="0" category="server" class="category" title="Információk az egyes lapokról, valamint néhány általános szerverrel kapcsolatos részlet.">
            <img class="serverIcon" style="border-radius: 420px">
            <p>Kezdőlap</p>
        </div>

        <div tabindex="0" category="xp" class="category" title="Általános szintbeállítások, például XP üzenetenként és szintskálázás.">
            <img src="/assets/categories/xp.svg">
            <p>XP szerzés</p>
        </div>

        <div tabindex="0" category="rewardroles" class="category" title="Bizonyos szintek elérése esetén automatikusan szerepköröket adni.">
            <img src="/assets/categories/rewardroles.svg">
            <p>Szint jutlmak</p>
        </div>

        <div tabindex="0" category="levelup" class="category" title="Küldjön személyre szabható üzenetet, amikor egy tag szintet lép vagy mérföldkövet ér el.">
            <img src="/assets/categories/levelup.svg">
            <p>Szintlépési üzenet</p>
        </div>

        <div tabindex="0" category="multipliers" class="category" title="Bizonyos szerepek/csatornák extra XP-t adnak, mások pedig egyáltalán nem.">
            <img src="/assets/categories/multipliers.svg">
            <p>Szórzó</p>
        </div>

        <div tabindex="0" category="rankcard" class="category" title="Módosítsd a rangkártyákon megjelenítendő információkat és részleteket.">
            <img src="/assets/categories/rankcard.svg">
            <p>Rang kártya</p>
        </div>

        <div tabindex="0" category="leaderboard" class="category" title="Kapcsolja be vagy ki a szerver ranglistáját, vagy módosítsa a adatvédelmi beállításokat.">
            <img src="/assets/categories/leaderboard.svg">
            <p>Toplista</p>
        </div>

        <div tabindex="0" category="data" class="category" title="Exportálja vagy törölje a szerver adatait.">
            <img src="/assets/categories/data.svg">
            <p>Adatok</p>
        </div>

        <div tabindex="0" category="advanced" class="category" title="Néhány extra fejlett/kísérleti beállítás a finomabb testreszabáshoz.">
            <img src="/assets/categories/advanced.svg">
            <p>Fejlett</p>
        </div>
    </div>

    <div id="unsavedWarning">
        <div class="unsavedBox">
            <p>Készen van?</p>
            <button style="background-color: var(--emojigreen)" id="saveChanges">Mentés</button>
        </div>
    </div>

    <div class="configboxes" tab="server" style="display: none" id="serverInfo">
        <div class="settingBox box fulllength" style="padding: 15px 20px; position: relative">
            <div class="centerflex">
                <img class="serverIcon" style="border-radius: 420px; height: 75px">
                <div style="margin-left: 18px; overflow: hidden;">
                    <h1 class="serverName" style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap; margin-bottom: 0px"></h1>
                    <p class="serverMembers" style="margin-top: 0px"></p>
                </div>
            </div>
            <div class="middleflex" style="position: absolute; top: 0px; right: 30px; height: 100%">
                <a tabindex=-1 href="/servers">
                    <button style="font-size: 24px; height: 50px; width: 200px; margin-right: 25px; background-color: var(--emojiblue)">Szerver váltás</button>
                </a>

                <a class="leaderboardLink" tabindex=-1 target="_blank" id="mainlbbutton">
                    <button style="font-size: 24px; height: 50px; width: 200px; background-color: var(--emojipurple)">Toplista</button>
                </a>
            </div>
        </div>

        <div class="settingBox box categoryBox canfocus" tabindex=0>
            <div class="centerflex">
                <img cat="icon">
                <div style="overflow: hidden">
                    <h2 cat="name"></h2>
                    <p cat="info" class="details" style="height: 56px"></p>
                    <p cat="extra" style="white-space: nowrap"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="configboxes" tab="xp" style="display: none">
        <div class="settingBox box fulllength">
            <h1>XP szerzés</h1>
            <p>A tagok üzenetküldéskor véletlenszerű mennyiségű XP-t (tapasztalati pontot) kapnak, és aktiválják a rövid várakozási időt. Amikor a várakozási idő letelt, újra XP-t szerezhetnek. Gratulálunk! Most már tudod, hogyan működnek az XP botok.</p>

            <h2>XP engedélyezése</h2>
            <p class="details">Ha engedélyezve van, a tagok XP-t szerezhetnek. Ez a bot lényege.</p>
            <label style="margin-top: 5px"; class="slider">
                <input db="enabled" id="enableLevelUp" type="checkbox" saveName="db">
                <span class="sliderspan"></span>
            </label>
        </div>

        <div class="settingBox box fulllength">
            <h1>Alap beállítások</h1>
            <p>Testreszabhatod a megszerzett XP mennyiségét, valamint azt, hogy milyen gyakran szerezhető meg. Elég egyszerű.</p>

            <div class="simpleflex">
                <div class="sideoption">
                    <h2>XP per üzenet</h2>
                    <p class="details">Az összeg véletlenszerűen kerül kiválasztásra a minimum és maximum érték között</p>
                    <div class="field">
                        <div class="centerflex spacedflex">
                            <p>Között</p>
                            <input updatecurve="true" id="num_min" style="width: 75px" type="number" min="0" max="5000" default="50" db="gain.min" saveName="db">
                            <p> és </p>
                            <input updatecurve="true" id="num_max" style="width: 75px" type="number" min="0" max="5000" default="50" db="gain.max" saveName="db">
                        </div>
                    </div>
                </div>

                <div class="sideoptions">
                    <h2>Cooldown</h2>
                    <p class="details">A tagoknak ennyi másodpercet kell várniuk, mielőtt újra XP-t szerezhetnek</p>
                    <div class="field">
                        <div class="centerflex spacedflex">
                            <input updatecurve="true" id="num_time" style="width: 100px" type="number" decimals="4" min="0" max="31536000" default="60" db="gain.time" saveName="db">
                            <p>másodperc</p>
                            <p id="cooldownunit" style="opacity: 70%; display: none"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="settingBox box fulllength">
            <h1>Szintskálázás</h1>
            <p>Elég XP pontot gyűjtve a tagok szintet léphetnek, és különleges szerepeket vagy dicsekvési jogokat szerezhetnek. A szükséges XP pontok száma a szintekkel arányosan növekszik – az alacsonyabb szinteken csak pár ezer pontra van szükség, de a magasabb szinteken már milliókra.</p>

            <p>Testreszabhatod a szintskálázást, hogy megváltoztasd, hány további pontra van szükség minden egyes szinthez.
                A kisebb görbe megkönnyíti a szintlépést, a nagyobb görbe pedig sokkal nehezebbé teszi.</p>


            <div class="simpleflex">
                <div class="sideoption">
                    <h2 id="curveStuff">Görbe képlet</h2>
                    <p class="details">Köbb függvény, amely meghatározza, mennyi XP szükséges minden szinthez</p>
                    <div class="field">
                        <div class="centerflex curvefield">
                            <input updatecurve="true" id="num_curve3" style="width: 65px" type="number" min="0" max="100" decimals="10" default="0" db="curve.3" saveName="db">
                            <p>x<sup>3</sup> &nbsp; &nbsp; + </p>
                            <input updatecurve="true" id="num_curve2" style="width: 65px" type="number" min="0" max="10000" decimals="10" default="0" db="curve.2" saveName="db">
                            <p>x<sup>2</sup> &nbsp; &nbsp; + </p>
                            <input updatecurve="true" id="num_curve1" style="width: 65px" type="number" min="0" max="100000" decimals="10" default="0" db="curve.1" saveName="db">
                            <p>x</p>
                        </div>
                    </div>
                    <p>Nehézségi fokozat: <b id="scaleDifficulty" style="color: aqua"></b></p>
                </div>

                <div class="sideoption">
                    <h2>Kerekítés</h2>
                    <p class="details">Kerekíti a szükséges XP-t egy szebb számra, pl. 791 XP -> 800 XP</p>
                    <div class="centerflex spacedflex">
                        <p>Kerekítsd a legközelebbi egész számra</p>
                        <input updatecurve="true" id="num_round" style="width: 80px" type="number" min="1" max="1000" default="1" db="rounding" saveName="db">
                    </div>
                </div>
            </div>
            
            <div class="simpleflex">
                <div>
                    <h2 style="margin-bottom: 12px">Előnézet</h2>
                    <div class="simpleflex flexTable" id="curvePreview"></div>
    
                    <button style="margin-top: 16px; width: 140px" id="showMoreCurveInfo">Több információ</button>
                </div>

                <div style="margin-left: 40px; margin-top: 68px">
                    <div id="xpGraph" class="desmos"></div>
                    <p class="details" id="desmosJumpscare" style="font-size: 10px; opacity: 25%">desmos ijesztő</p>
                </div>
            </div>

            <div id="fullPreviewSection" style="display: none">
                <h2 style="margin-bottom: 12px">Teljes táblázat</h2>
                <div class="simpleflex flexTable" id="fullCurvePreview"></div>

                <button style="margin-top: 16px; width: 140px; background-color: var(--emojipurple)" onclick="$('#fullPreviewSection').hide()">Hide</button>
            </div>
        </div>

        <div class="settingBox box fulllength">
            <h1>Előre beállított értékek</h1>
            <p>Az egyensúly megteremtése nehéz feladat. Íme néhány előre beállított érték, amelyek közül választhat!</p>

            <div class="simpleflex">
                <div style="width: 750px">
                    <h2>Beállított érték megtekintése</h2>
                    <p class="details">Nincsenek beállítások, amíg nem kattintasz az "alkalmaz" gombra</p>
                    <select id="curvePresets"></select>

                    <p id="presetDesc" style="margin-bottom: 8px; font-style: italic;">Görbe leírása</p>
                    <div class="curveInfo">
                        <p>- <b>Görbe:</b> <span id="presetCurve"></span></p>
                        <p>- <b>Nehézség:</b> <span id="presetDifficulty"></span></p>
                        <p>- <b>Kerekítés:</b> <span id="presetRound"></span></p>
                        <p>- <b>XP per üzenet:</b> <span id="presetXP"></span></p>
                    </div>
                    <button id="applyPreset" style="margin-top: 12px;">Beállítás alkalmazása</button>
                </div>
            </div>
        </div>
    </div>


    <div class="configboxes" tab="rewardroles" style="display: none">
        <div class="settingBox box fulllength">
            <h1>Jultalmak</h1>
            <p style="margin-bottom: 3px">Automatikusan hozzárendelhet szerepeket a tagokhoz, amikor elérik egy bizonyos szintet. Ingyenesen.</p>
            <p class="details">Képzeld el, ha megpróbálnék egy pár extra sor kódból profitálni, haha, az teljesen őrültség lenne.</p>

            <h2>Rang hozzáadása</h2>

            <div style="margin-top:10px" class="centerflex spacedflex">
                <p>Jutalom</p>
                <select id="rewardRoleSelect"></select>
                <p>Szinten</p>
                <input id="rewardLevel" type="number" style="width: 90px" min="1" max="1000">
            </div>

            <div class="centerflex spacedflex">
                <p>Ezt a szerepkört akkor távolítsa el, ha magasabb szerepkört szerez</p>
                <label style="margin-top: 5px"; class="slider">
                    <input id="rewardKeep" type="checkbox" checked>
                    <span class="sliderspan"></span>
                </label>
            </div>

            <div class="centerflex spacedflex excludeMode">
                <p>Haladó: A szerepkörök szinkronizálásakor ezt a szerepkört kizárni</p>
                <label style="margin-top: 5px"; class="slider">
                    <input id="rewardExclude" type="checkbox">
                    <span class="sliderspan"></span>
                </label>
            </div>

            <button style="margin-top: 10px" id="addRewardRole">Hozzáadás</button>

            <h2 style="margin-top: 50px; margin-bottom: 15px">Jelenlegi jutalmak (<span id="rewardCount">0</span>)</h2>

            <div class="simpleflex flexTable" id="rewards"></div>
        </div>

        <div class="settingBox box fulllength">
            <h1>Jutalom szinkronizálás</h1>
            <p>Alapértelmezés szerint a bot automatikusan szinkronizálja a szint szerepeket azáltal, hogy hozzáadja a hiányzókat és eltávolítja a helyteleneket. Nyugodtan módosíthatja ezt a viselkedést egy kicsit.</p>

            <div class="simpleflex">
                <div class="sideoption">
                    <h2>Automatikus szinkronizálás</h2>
                    <p class="details">Válaszd ki, mikor szinkronizálja automatikusan a bot a szint szerepeket</p>
                    <select db="rewardSyncing.sync" saveName="db">
                        <option value="level">Szintlépéskor</option>
                        <option value="xp">XP szerzéskor (lassabb)</option>
                        <option value="never">Soha</option>
                    </select>
                </div>

                <div class="sideoptions">
                    <h2>Manuális szinkronizálás</h2>
                    <p class="details">Ha a tagok bármikor manuálisan szinkronizálhatják szerepeiket, amikor csak akarják</p>

                    <label style="margin-top: 5px"; class="slider">
                        <input type="checkbox" tabindex="0" db="rewardSyncing.noManual" invert="true" saveName="db">
                        <span class="sliderspan"></span>
                    </label>
                </div>
            </div>

            <div class="simpleflex" style="margin-top: 40px">
                <div class="sideoption">
                    <h2>Szinkronizálási figyelmeztetés megjelenítése</h2>
                    <p class="details">Figyelmeztető üzenetet jelenít meg a /rank-ban, ha egy tag szerepei nem szinkronizálódnak megfelelően.</p>

                    <label style="margin-top: 5px"; class="slider">
                        <input type="checkbox" tabindex="0" db="rewardSyncing.noWarning" invert="true" saveName="db">
                        <span class="sliderspan"></span>
                    </label>
                </div>

                <div class="sideoptions">
                    <h2>Haladó: Szerepkörök kizárása</h2>
                    <p class="details">Bizonyos szerepkörök megakadályozása az újra hozzáadásban vagy eltávolításban a szinkronizálás során.</p>

                    <label style="margin-top: 5px"; class="slider">
                        <input type="checkbox" tabindex="0" id="excludeRewardToggle">
                        <span class="sliderspan"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>


    <div class="configboxes" tab="levelup" style="display: none">
        <div class="settingBox box fulllength">
            <h1>Szintlépési üzenet</h1>
            <p>Küldj automatikus üzenetet a csevegésben, amikor egy tag szintet lép. Milyen szórakoztató!</p>

            <h2>Üzenet engedélyezése</h2>
            <p class="details">Ha engedélyezve van, akkor üzenet vagy DM kerül elküldésre, amikor valaki szintet lép.</p>
            <label style="margin-top: 5px"; class="slider">
                <input db="levelUp.enabled" type="checkbox" saveName="db" onchange="$('.ifmessageenabled').toggle($(this).prop('checked'))">
                <span class="sliderspan"></span>
            </label>
        </div>
        <div class="settingBreak"></div>

        <div class="settingBox box fulllength ifmessageenabled">

            <div id="regularMessage">
                <h1>Üzenet</h1>                  
                <p>A szintlépéskor elküldendő üzenet.</p>
                <textarea class="lvlTextbox" id="lvlUpMessage" style="width: 800px" placeholder="(no message)" saveName="levelUp.message"></textarea>
            </div>

            <div id="embedMessage">
                <h1>Beágyazás</h1>                  
                <p>A szintlépéskor elküldendő beágyazott üzenet.</p>
                <p><b>1. lépés: </b> <a target="_blank" href="https://discohook.org/?data=eyJtZXNzYWdlcyI6W3siZGF0YSI6eyJjb250ZW50IjpudWxsLCJlbWJlZHMiOlt7InRpdGxlIjoi4pyoIExldmVsIHVwISIsImRlc2NyaXB0aW9uIjoiKipbW1VTRVJOQU1FXV0qKiBoYXMgcmVhY2hlZCBsZXZlbCAqKltbTEVWRUxdXSoqISBDb25ncmF0dWxhdGlvbnMhIiwiY29sb3IiOjE2NzQ0NDQ4LCJmb290ZXIiOnsidGV4dCI6IlRoZXkgbm93IGhhdmUgW1tYUF1dIFhQIn19XSwiYXR0YWNobWVudHMiOltdfX1dfQ">Beágyazás létrehozása itt!</a></p>
                <p><b>2. lépés: </b> Nyissa meg a JSON adatokat a 'JSON Data Editor' az oldal alján</p>
                <p><b>3. lépés: </b> Másolja a szöveget, és illessze be az alábbi mezőbe</p>
                <p class="details" style="margin-bottom: 15px">*Minden változó (pl. [[USERNAME]]) müködnek beágyazásban is!</p>
                <textarea class="lvlTextbox codeArea" id="lvlUpEmbed" style="width: 800px" placeholder="(no embed)" saveName="levelUp.message"></textarea>
                <p id="invalidLevelUpEmbed" class="red" style="display: none"><b>Figyelmeztetés: </b>Érvénytelen beágyazott JSON-adat! Ez a beágyazás nem fog működni.</p>
            </div>

            <div class="simpleflex">
                <div class="sideoption"> 
                    <h2>Változók</h2>
                    <p class="details">Tegye izgalmasabbá üzenetét dinamikus változókkal!</p>

                    <div id="lvlUpMessageVariables" class="varList">
                        <select>
                            <option value="x" selected disabled>XP</option>
                            <option value="[[LEVEL]]">Szint (pl. 10)</option>
                            <option value="[[OLD_LEVEL]]">Előző szint (pl. 9)</option>
                            <option value="[[XP]]">XP (pl. 10,000)</option>
                            <option value="[[NEXT_LEVEL]]">Következő szint (pl. 11)</option>
                            <option value="[[NEXT_XP]]">Az XP a kövezkező szinthez (pl. 1,000)</option>
                        </select>
        
                        <select>
                            <option value="x" selected disabled>Tag</option>
                            <option value="[[@]]">@említés (pl. @Polaris)</option>
                            <option value="[[DISPLAYNAME]]">Globális név (pl. Polaris)</option>
                            <option value="[[USERNAME]]">Felhasználónév (pl. polaris)</option>
                            <option value="[[ID]]">ID (pl. 98341916...)</option>
                            <option value="[[NICKNAME]]">Becenév</option>
                            <option value="[[AVATAR]]">Avatar URL</option>
                        </select>
        
                        <select>
                            <option value="x" selected disabled>Szerver</option>
                            <option value="[[SERVER]]">Szerver név</option>
                            <option value="[[SERVER_ICON]]">Szerver ikon URL</option>
                            <option value="[[SERVER_ID]]">Szerver ID</option>
                            <option value="[[CHANNEL]]">Csatorna tag (pl. #channel)</option>
                            <option value="[[CHANNEL_NAME]]">Csatorna név (pl. channel)</option>
                            <option value="[[CHANNEL_ID]]">Csatorna ID</option>
                        </select>
        
                        <select>
                            <option value="x" selected disabled>Fejlett</option>
                            <!-- <option value="[[DISCRIM]]">Account Discriminator (e.g. 6880)</option> -->
                            <option value="[[LEVEL]][[NTH]]">Nth(Angol számolásban a .-dik) (1st, 2nd, 3rd, stb.)</option>
                            <option value="<t:[[TIMESTAMP]]>">Időbélyeg</option>
                            <option value="[[EMBEDTIMESTAMP]]">Beágyazási Időbélyeg</option>
                            <option value="[[CHOOSE | Message 1 | Message 2 | Message 3... ]]">Random választás</option>
                            <option value="[[CHOOSE | Normal message | <2> 2x as likely to appear | <0.5> 0.5x as likely to appear... ]]">Random választás (súlyozott)</option>
                            <option value="[[IFLEVEL = 10 | Only appears on level 10 (can also use >, >=, <, <=, !=, or /) ]]">Szint kondicíó</option>
                            <option value="[[IFROLE | Only appears upon gaining a role. You now have [[ROLE]] / [[ROLE_NAME]]! ]]">Jutalom kondicíó</option>
                        </select>

                        <select style="margin-top: 7px; display: none" id="roleVariables">
                            <option value="x" selected disabled>Rang</option>
                            <option value="[[ROLE]]">Jutalom rang (pl. @Legendás)</option>
                            <option value="[[ROLE_NAME]]">Jutalom rang neve (pl. Legendás)</option>
                        </select>
                    </div>
                </div>

                <div class="sideoption"> 
                    <h2>Példa</h2>
                    <p class="exampleP details" id="exampleInfo">Teszt üzenet küldése.</p>
                    <p class="details" id="sendingExample" style="display: none">Küldés...</p>
                    <p class="exampleP details" id="exampleSent" style="opacity: 100%; display: none; color: lime">Példa elküldve! Ellenőrizd az üzeneteidet.</p>
                    <p class="exampleP details" id="exampleError" style="opacity: 100%; display: none; color: red">Hiba történt a példa küldésekor! Engedélyezve vannak az üzeneteid?</p>
                    <div style="display: flex" class="spacedflex">
                        <button id="sendExample" style="background-color: var(--emojipurple)">Teszt üzenet küldve DM-ben</button>
                        <input id="exampleLevel" type="number" min="1" max="1000" placeholder="Level" style="height: 37px; width: 70px">
                    </div>
                </div>
            </div>

            <div class="simpleflex" style="margin-top: 15px">
                <div class="sideoption"> 
                    <h2>Csatorna</h2>
                    <p class="details">Melyik csatornán keresztül kell elküldeni az üzenetet?</p>
                    <select id="lvlMessageSelect" saveName="levelUp.channel">
                            <option value="current">Aktuális csatorna</option>
                            <option value="dm">Küldés DM-ben</option>
                    </select>
                </div>

                <div class="sideoption"> 
                    <h2>Beágyazás mód</h2>
                    <p class="details">Küldj egy díszes beágyazást a szokásos üzenet helyett (haladó szintű!)</p>
                    <label style="margin-top: 5px"; class="slider">
                        <input id="toggleLvlUpEmbed" type="checkbox" tabindex="0" db="levelUp.embed" saveName="db">
                        <span class="sliderspan"></span>
                    </label>
                </div>
            </div>
        </div>
        <div class="settingBreak"></div>
        
        <div class="settingBox box fulllength ifmessageenabled">
            <h1>Intervalum</h1>
            <p class=>Milyen gyakran kell elküldeni az üzenetet (pl. minden 3. szinten)</p>

            <div class="simpleflex" style="margin-bottom: 25px">
                <div class="sideoption">
                    <h2>Töbszörös kiküldés</h2>
                    <p class="details">A szintlépő üzenetek csak akkor fognak elküldésre kerülni, ha elérik ennek a számnak a többszörösét<br>(pl. egy 5-ös többszörös esetén a 5., 10., 15., 20., 25. szinteken fog elküldésre kerülni...)</p>
                    <div class="field">
                        <div class="centerflex spacedflex">
                            <p>Minden</p>
                            <input id="num_levelinterval" style="width: 100px" type="number" min="1" max="1000" default="1" db="levelUp.multiple" saveName="db">
                            <p>szint(ek)</p>
                        </div>
                    </div>
                </div>

                <div class="sideoptions" style="width: 600px">
                    <h2>Töbszörös kiküldés használata</h2>
                    <p class="details">Ha egy tag eléri ezt a szintet, a többszörös már nem lesz érvényben, és szintlépő üzenet fog érkezni minden szintre (0-ra állítva letiltható)</p>
                    <div class="field">
                        <div class="centerflex spacedflex">
                            <p>Szint</p>
                            <input id="num_levelinterval" style="width: 100px" type="number" min="0" max="1000" default="0" db="levelUp.multipleUntil" saveName="db">
                        </div>
                    </div>
                </div>
            </div>

            <div class="sideoption"> 
                <h2>Csak jutalom szerepek</h2>
                <p class="details">Only send the level up message when obtaining a new reward role</p>
                <label style="margin-top: 5px"; class="slider">
                    <input type="checkbox" tabindex="0" db="levelUp.rewardRolesOnly" saveName="db" onchange="$('#roleVariables').toggle($(this).prop('checked'))">
                    <span class="sliderspan"></span>
                </label>
            </div>
        </div>
    </div>

    <div class="configboxes" tab="multipliers" style="display: none">
        <div class="settingBox box fulllength" style="padding-bottom: 15px">
            <h1>Szórzók</h1>
            <p style="margin-bottom: 3px">Bizonyos szerepek/csatornák extra XP-t adnak, vagy egyáltalán nem adnak.</p>
            <p class="details">2x szorzó dupla XP-t ad, 0x szorzó letiltja az XP szerzést, stb.</p>
        </div>
        <div class="settingBreak"></div>

        <div class="settingBox box">
            <h2>Szerepkör-szorzó hozzáadása</h2>
            <p class="details" style="padding-right: 30px">A szorzó szerepet betöltő tagok üzeneteikből szerzett XP-pontjaikat az alábbi értékkel szorozzuk meg</p>

            <div style="margin-top:10px" class="centerflex spacedflex">
                <select id="roleMultiplierSelect"></select>
                <p>ad</p>
                <input id="roleMultiplierAmount" type="number" decimals="4" style="width: 70px; margin-right: 2px" min="0" max="100">
                <p>⨯ XP</p>
            </div>

            <button style="margin-top: 10px" id="addRoleMultiplier">Hozzáadás</button>

            <h2 style="margin-top: 50px; margin-bottom: 15px">Rang szórzók (<span id="roleMultiplierCount">0</span>)</h2>

            <div class="simpleflex flexTable" id="roleMultipliers"></div>

            <h2 style="margin-top: 40px">Rang prioritás</h2>
            <p class="details">Ha egy tagnak több rangja van, melyik élvezzen prioritást?<br>(0x szorzók mindig prioritást élveznek, függetlenül ettől a beállítástól)</p>
            <select db="multipliers.rolePriority" id="rolePriority" desc="role" class="multiplierSelect" saveName="db">
                <option value="largest">Legnagyobb szorzó</option>
                <option value="smallest">Legkisebb szorzó</option>
                <option value="highest">Legmagasabb rang</option>
                <option value="add">Összeadás</option>
                <option value="combine">MINDEN ÖSSZEFOGLALÁSA!!! (rossz ötlet)</option>
            </select>
            <p class="details multiplierDescription" id="roleMultiplierDescription">If you have 2.0x and 3.0x role multipliers, they will be multiplied to 6.0x. Scales absurdly fast</p>
        </div>

        <div class="settingBox box">
            <h2>Add a channel multiplier</h2>
            <p class="details">Category multipliers will only apply to channels that do not have a more specific multiplier set. Threads without a multiplier will default to their parent channel.</p>

            <div style="margin-top:10px" class="centerflex spacedflex">
                <select id="channelMultiplierSelect"></select>
                <p>grants</p>
                <input id="channelMultiplierAmount" type="number" decimals="4" style="width: 70px; margin-right: 2px" min="0" max="100">
                <p>⨯ XP</p>
            </div>

            <button style="background-color: var(--emojipurple); margin-top: 10px" id="addChannelMultiplier">Add</button>

            <h2 style="margin-top: 50px; margin-bottom: 15px">Channel multipliers (<span id="channelMultiplierCount">0</span>)</h2>

            <div class="simpleflex flexTable" id="channelMultipliers"></div>

            <h2 style="margin-top: 40px">Stacking</h2>
            <p class="details">What should be done if a member also has a multiplier role?<br>(XP gain will always be if either multiplier is 0x)</p>
            <select db="multipliers.channelStacking" id="channelStacking" desc="channel" class="multiplierSelect" saveName="db">
                <option value="multiply">Multiply together with role</option>
                <option value="add">Add together with role</option>
                <option value="largest">Use the higher multiplier</option>
                <option value="channel">Always use the channel multiplier</option>
                <option value="role">Always use the role multiplier</option>
            </select>
            <p class="details multiplierDescription" id="channelMultiplierDescription">If you have 2.0x and 3.0x role multipliers, they will be multiplied to 6.0x. Scales absurdly fast</p>
        </div>

    </div>

    <div class="configboxes" tab="rankcard" style="display: none">
        <div class="settingBox box fulllength">
            <h1>Rank Card</h1>
            <p>Tweak the details shown on rank cards.<br>Some settings may also apply to the online leaderboard.</p>
            <a class="leaderboardLink" tabindex=-1 target="_blank"><button style="background-color: var(--emojipurple)">Visit leaderboard</button></a>

            <h2>Enable rank cards</h2>
            <p class="details">Allows members to check their XP with /rank. Disabling this will also hide most info in /calculate.</p>
            <label style="margin-top: 5px"; class="slider">
                <input type="checkbox" tabindex="0" db="rankCard.disabled" invert="true" saveName="db" onchange="$('.ifrankenabled').toggle($(this).prop('checked'))">
                <span class="sliderspan"></span>
            </label>
        </div>
        <div class="settingBreak"></div>
        
        <div class="settingBox box ifrankenabled">
            <h2>Hide cooldown</h2>
            <p class="details">Prevents members from viewing the amount of time until they can gain XP again.</p>
            <label style="margin-top: 5px"; class="slider">
                <input type="checkbox" tabindex="0" db="rankCard.hideCooldown" saveName="db">
                <span class="sliderspan"></span>
            </label>
        </div>

        <div class="settingBox box">
            <h2>Hide multipliers</h2>
            <p class="details">Prevents members from viewing which roles have multipliers. (except 0x)</p>
            <label style="margin-top: 5px"; class="slider">
                <input type="checkbox" tabindex="0" db="hideMultipliers" saveName="db">
                <span class="sliderspan"></span>
            </label>
        </div>

        <div class="settingBox box ifrankenabled" style="height: 171px">
            <h2>Force hidden</h2>
            <p class="details">Forces usages of /rank to always be hidden (ephemeral), meaning that only the member who typed the command can see the message.<br></p>
            <label style="margin-top: 5px"; class="slider">
                <input type="checkbox" tabindex="0" db="rankCard.ephemeral" saveName="db">
                <span class="sliderspan"></span>
            </label>
        </div>

        <div class="settingBox box ifrankenabled" style="height: 171px">
            <h2>Relatív XP</h2>
            <p class="details">A /rank parancs „következő szint” szakaszát úgy módosítja, hogy 0-tól kezdődjön, és csak az adott szint XP-jét tartalmazzon. Például: ha a 10. szinthez 2000 XP szükséges, a 11. szinthez pedig 3000, akkor egy 2500 XP-vel rendelkező tag esetében a parancs „500/1000 XP a 11. szintig” üzenetet jelenít meg.</p>
            <label style="margin-top: 5px"; class="slider">
                <input type="checkbox" tabindex="0" db="rankCard.relativeLevel" saveName="db">
                <span class="sliderspan"></span>
            </label>
        </div>

        <div class="settingBox box ifrankenabled">
            <h2>Rangkártya testreszabás</h2>
            <p class="details">Már nem az én problémám.</p>
        </div>

    </div>

    <div class="configboxes" tab="leaderboard" style="display: none">
        <div class="settingBox box fulllength">
            <h1>Ranglista</h1>
            <p>Állítsa be a ranglistával kapcsolatos beállításokat. Jó a magánélethez.</p>
            <a class="leaderboardLink" tabindex=-1 target="_blank"><button style="background-color: var(--emojipurple)">Ranglista megtekintése</button></a>

            <h2>Ranglista engedélyezése</h2>
            <p class="details">Lehetővé teszi a tagok számára, hogy megtekinthessék és összehasonlíthassák rangjaikat egy nagy ranglistán.</p>
            <label style="margin-top: 5px"; class="slider">
                <input type="checkbox" tabindex="0" db="leaderboard.disabled" invert="true" saveName="db" onchange="$('.iflbenabled').toggle($(this).prop('checked'))">
                <span class="sliderspan"></span>
            </label>
        </div>
        <div class="settingBreak"></div>

        <div class="settingBox box ifrankenabled">
            <h2>Erő rejtett</h2>
            <p class="details">Kényszeríti, hogy a /top használata mindig rejtett (ephemeral) legyen.<br></p>
            <label style="margin-top: 5px"; class="slider">
                <input type="checkbox" tabindex="0" db="leaderboard.ephemeral" saveName="db">
                <span class="sliderspan"></span>
            </label>
        </div>

        <div class="settingBox box iflbenabled">
            <h2>Jutalom szerepek elrejtése</h2>
            <p class="details">Letiltja a jutalomszerepek listájának megtekintését az online ranglistán keresztül.</p>
            <label style="margin-top: 5px"; class="slider">
                <input type="checkbox" tabindex="0" db="leaderboard.hideRoles" saveName="db">
                <span class="sliderspan"></span>
            </label>
        </div>

        <div class="settingBox box iflbenabled">
            <h2>Minimum szint</h2>
            <p class="details">A ranglistát azoknak a tagoknak korlátozza, akik elérték egy bizonyos szintet. Ha 0-ra van állítva, akkor minden szerver tagot megjeleníti.</p>
            <div class="centerflex spacedflex">
                <input id="maxEntries" style="width: 100px" type="number" min="0" max="1000" placeholder="0" default="0" db="leaderboard.minLevel" saveName="db">
            </div>
        </div>

        <div class="settingBox box iflbenabled">
            <h2>Maximális tagok száma</h2>
            <p class="details">Csak a ranglistán szereplő első X tag megtekintését engedélyezi. 0 értékre állítva minden szerver tagot megjeleníti.</p>
            <div class="centerflex spacedflex">
                <input id="maxEntries" style="width: 100px" type="number" min="0" max="1000000" placeholder="0" default="0" db="leaderboard.maxEntries" saveName="db">
            </div>
        </div>

        <div class="settingBox box iflbenabled">
            <h2>Privát ranglista</h2>
            <p class="details">Korlátozza az online ranglistát, így csak a szerver tagjai férhetnek hozzá.<br> (bejelentkezés szükséges)</p>
            <label style="margin-top: 5px"; class="slider">
                <input type="checkbox" tabindex="0" db="leaderboard.private" saveName="db">
                <span class="sliderspan"></span>
            </label>
        </div>

    </div>


    <div class="configboxes" tab="data" style="display: none">
        <div class="settingBox box fulllength" style="padding-bottom: 15px">
            <h1>Adatok</h1>
            <p>A szerver adataival kapcsolatos beállítások.</p>
        </div>
        <div class="settingBreak"></div>

        <div class="settingBox box fulllength">
            <h2>XP letöltése</h2>
            <p class="details" style="margin-bottom: 10px">Mindenki XP-jét egyetlen fájlba exportálja (csak a felhasználói azonosítót és az XP-t tartalmazza).<br><b>Töltse le az összes adatot, ha beállításait a Polaris nyílt forráskódú forkjába szeretné importálni.</b></p>
            <button class="exportXP" format="everything" style="background-color: var(--emojipurple);">Az összes adat letöltése</button>
            <button class="exportXP" format="json" style="margin-left: 10px">Letöltése .json fájl ként</button>
            <button class="exportXP" format="csv" style="margin-left: 10px">Letöltése .csv fájl ként</button>
            <button class="exportXP" format="txt" style="margin-left: 10px">Letöltés .txt fájl ként</button>
        </div>
        <div class="settingBreak"></div>

        <div class="settingBox box">
            <h2>Összes XP törlése</h2>
            <p class="details">Törölje mindenki XP-jét, és kezdjen újra. Minden XP 0-ra lesz állítva, de a jutalomszerepek nem lesznek eltávolítva, hacsak nem végzi el manuálisan. <b>Ez visszafordíthatatlan!</b></p>
            <button style="background-color: var(--emojired)" onclick="$('.confirmReset').toggle(); $('.confirmConfirmReset').hide()">Reset!</button>
            <button class="hideOnLoad confirmReset" style="margin-left: 10px; background-color: var(--emojiblue); display: none;" onclick="$('.confirmConfirmReset').toggle()">Are you sure?</button>
            <button class="hideOnLoad confirmConfirmReset" style="margin-left: 10px; background-color: var(--emojipurple); display: none;" id="resetXP">Positive?</button>
        </div>

        <div class="settingBox box">
            <h2>Beállítások visszaállítása</h2>
            <p class="details">Visszaállítja az összes konfigurálható beállítás alapértelmezett értékeit, mint például a görbe, jutalom szerepkörök, szorzók, szintlépési üzenet stb. Az XP nem kerül törlésre. <b>Ez visszafordíthatatlan!</b></p>
            <button style="background-color: var(--emojired)" onclick="$('.confirmResetSettings').toggle()">Reset!</button>
            <button class="hideOnLoad confirmResetSettings" style="margin-left: 10px; background-color: var(--emojiblue); display: none;" id="resetSettings">Are you sure?</button>
        </div>
        <div class="settingBreak"></div>

        <div class="settingBox box">
            <h2>Tagok Pruneolása</h2>
            <p class="details">Törli azoknak az adatok, akiknek kevesebb, mint egy bizonyos mennyiségű XP-jük van. Ez felgyorsíthatja a betöltési időket. <b>Ez visszafordíthatatlan!</b></p>
            <div class="centerflex spacedflex">
                <p>Kevesebb mint: </p>
                <input id="prune_amt" style="width: 150px" type="number" min="1" default="100" value="100">
                <button id="confirmPrune" style="background-color: var(--emojired)">Prune!</button>
            </div>
        </div>

        <div class="settingBox box fulllength" id="importBotSection">
            <div class="spacedflex centerflex" style="margin-top: 15px; margin-bottom: 5px">
                <h2 style="margin: 0px 0px">Import settings and XP from</h2>
                <select id="importfrom" style="margin-left: 8px; width: 250px; font-weight: bold;" onchange="$('.importdiv').hide(); $(`.importdiv[importtype='${$(this).val()}']`).show()">
                    <option value="json">.json fájl</option>
                    <option value="polaris">Másik szerver</option>
                </select>
            </div>

            <div class="importdiv" importtype="json">
                <p class="details">XP és beállítások másolása egy másik szerverről, amely ezt a botot használja. <b>Szerver tulajdonos szükséges</b></p>
                <p class="details">A várt .json formátum megegyezik azzal, amikor a "letöltés az összes adat" gombra kattintasz ennek az oldalnak a tetején</p>
                
                <div class="centerflex spacedflex">
                    <p>Importálás innen:</p>
                    <input type="file" id="importJSONFile" accept="application/json" style="padding-top: 15px; width: 500px; margin: 10px 0px"></select>
                </div>

                <div class="centerflex spacedflex">
                    <label class="slider">
                        <input class="importSetting" option="xp" type="checkbox" checked>
                        <span class="sliderspan"></span>
                    </label>
                    <p>XP importálása (felülírja a meglévő tagokat!)</p>
                </div>

                <div class="centerflex spacedflex">
                    <label class="slider">
                        <input class="importSetting forDevs" option="settings" type="checkbox" disabled>
                        <span class="sliderspan"></span>
                    </label>
                    <p>Beállítások importálás (cooldown, curve, szintlépési üzenet, stb.) <b>[bot tulajdonos szükséges biztonsági okok miatt]</b></p>
                </div>
            </div>

            <div class="importdiv" importtype="polaris" style="display: none">
                <p class="details">XP és beállítások másolása egy másik szerverről, amely ezt a botot használja. <b>Szerver tulajdonos szükséges</b></p>
                <p class="details"><b>Megjegyzés:</b> Mivel egy másik szerverről történik az átvitel, a jutalom szerepkörök és szorzók nem másolhatók</p>
                <div class="centerflex spacedflex">
                    <p>Importálás innen:</p>
                    <select class="importSetting" option="serverID" id="otherServers"></select>
                </div>

                <div class="centerflex spacedflex">
                    <label class="slider">
                        <input class="importSetting" option="xp" type="checkbox" checked>
                        <span class="sliderspan"></span>
                    </label>
                    <p>XP importálása (felülírja a meglévő tagokat!)</p>
                </div>

                <div class="centerflex spacedflex">
                    <label class="slider">
                        <input class="importSetting" option="settings" type="checkbox" checked>
                        <span class="sliderspan"></span>
                    </label>
                    <p>Beállítások importálás (cooldown, curve, szintlépési üzenet, stb.)</p>
                </div>
            </div>

            <div style="height: 60px" id="botimporting">
                <button style="margin-top: 15px; background-color: var(--emojigreen)" onclick="$('#confirmBotImport').toggle()">Import!</button>
                <button class="hideOnLoad" style="margin-left: 10px; background-color: var(--emojiblue); display: none;" id="confirmBotImport">Are you sure?</button>
            </div>

            <div style="display: none" id="botimportloading">
                <p><b>Dolgozunk rajta...</b></p>
            </div>
            
        </div>
        
    </div>

    <div class="configboxes" tab="advanced" style="display: none">

        <div class="settingBox box fulllength" style="padding-bottom: 15px">
            <h1>Fejlett beállítások</h1>
            <p>Néhány extra, menő vagy kísérleti opció.</p>
        </div>

        <div class="settingBox box" style="height: 171px">
            <h2>Engedélyek figyelmen kívül hagyása</h2>
            <p class="details">Mindenki számára engedélyezve van a moderációs parancsok (például /addxp vagy /clear) használata, még akkor is, ha nem rendelkezik a Szerver Kezelése jogosultsággal. Úgy lehet hasznos, ha egyéni slash parancs jogosultságokat szeretnél beállítani a szerveren.</p>
            <label style="margin-top: 5px"; class="slider">
                <input type="checkbox" tabindex="0" db="manualPerms" saveName="db">
                <span class="sliderspan"></span>
            </label>
        </div>

        <div class="settingBox box" style="height: 171px">
            <h2>Maximum Szint</h2>
            <p class="details">A legmagasabb szint, amit a tagok elérhetnek. Ezután is szerezhetnek XP-t.<br>Az XP szerzés letiltásához a max szint elérése után használj egy jutalom szerepkört 0x szorzóval.</p>
            <div class="centerflex spacedflex" style="margin-top: 10px">
                <input style="width: 80px" type="number" min="0" max="1000" placeholder="1000" default="1000" db="maxLevel" saveName="db">
            </div>
        </div>

        <div class="settingBox box" style="height: 145px">
            <h2>Egyedi /rank Embed Szín</h2>
            <p class="details">Megváltoztatja az embed színét a /rank használatakor.<br>Alapértelmezés szerint a tag szerepkör/színét használja.</p>
            <div class="centerflex" style="height: 45px">
                <label style="margin-top: 5px"; class="slider">
                    <input type="checkbox" tabindex="0" id="useCustomEmbedColRank" onchange="$('#customEmbedColRankConfig').toggle($(this).prop('checked')); checkUnsavedChanges()">
                    <span class="sliderspan"></span>
                </label>

                <div id="customEmbedColRankConfig" class="centerflex" style="display: none">
                    <input style="width: 100px; margin-left: 20px" class="colorInput" for="customEmbedColRank" maxlength="7" value="#00ff80" placeholder="#00ff80">
                    <div style="margin-left: 10px" class="colInputPreview" for="customEmbedColRank" tabindex="0"></div>
                    <input class="hiddenColInput previewColorInput" value="#00ff80" type="color" id="customEmbedColRank" db="rankCard.embedColor" saveName="db" useIf="useCustomEmbedColRank">
                </div>
            </div>
        </div>

        <div class="settingBox box" style="height: 145px">
            <h2>Egyedi /top Embed Szín</h2>
            <p class="details">Megváltoztatja az embed színét a /top használatakor.<br>Alapértelmezés szerint a Polaris zöldjét használja.</p>
            <div class="centerflex" style="height: 45px">
                <label style="margin-top: 5px"; class="slider">
                    <input type="checkbox" tabindex="0" id="useCustomEmbedColTop" onchange="$('#customEmbedColTopConfig').toggle($(this).prop('checked')); checkUnsavedChanges()">
                    <span class="sliderspan"></span>
                </label>

                <div id="customEmbedColTopConfig" class="centerflex" style="display: none">
                    <input style="width: 100px; margin-left: 20px" class="colorInput" for="customEmbedColTop" maxlength="7" value="#00ff80" placeholder="#00ff80">
                    <div style="margin-left: 10px" class="colInputPreview" for="customEmbedColTop" tabindex="0"></div>
                    <input class="hiddenColInput previewColorInput" value="#00ff80" type="color" id="customEmbedColTop" db="leaderboard.embedColor" saveName="db" useIf="useCustomEmbedColTop">
                </div>
            </div>
        </div>

    </div>

</body>

<script type="text/javascript" src="/polaris.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135255146-1"></script>
<script>window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-135255146-1');</script>
<script src="https://www.desmos.com/api/v1.7/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script>

<script>
    addUhOh()

    let guildID = window.location.pathname.split("/").pop().split("-")[0]
    let serverName = guildID
    let lastUpdated = 0

    const multiplierDescriptions = {
        role: {
            largest: "Ha 0.5x és 2.0x szerepkör szorzóid vannak, a 2.0x lesz kiválasztva.",
            smallest: "Ha 0.5x és 2.0x szerepkör szorzóid vannak, a 0.5x lesz kiválasztva.",
            highest: "Ha több szerepkör szorzód van, a legmagasabb listázott szerepkör lesz kiválasztva.",
            add: "Ha 1.5x, 2.0x és 0.75x szerepkör szorzóid vannak, összeadódnak 2.25x-re. (mindegyikből n-1 hozzáadva)",
            combine: "Ha 2.0x és 3.0x szerepkör szorzóid vannak, megszorzódnak 6.0x-re. Rendkívül gyorsan skálázódik."
        },

        channel: {
            multiply: "Ha a szerepköröd 2.0x és a csatorna 3.0x, a végső szorzó 6.0x.",
            add: "Ha a szerepköröd 2.0x és a csatorna 1.5x, összeadódnak 2.5x-re. (mindegyikből n-1 hozzáadva)",
            largest: "Ha a szerepköröd 2.0x és a csatorna 1.5x, a 2.0x lesz kiválasztva, mert nagyobb.",
            channel: "Ha a csatornának van bármilyen szorzója (beleértve az 1.0x-et is), mindig azt használd a szerepkör helyett.",
            role: "Ha van bármilyen szerepkör szorzód (beleértve az 1.0x-et is), mindig azt használd a csatorna helyett."
        }
    }

    Fetch(`/api/settings/${guildID}`).then(data => {

        console.log(data)

        let db = data.settings
        serverName = data.guild.name
        document.title = "Settings for " + serverName
        lastUpdated = data.guild.lastUpdate || 0

        // curve graph ft. desmos
        let desmosConfig = {
            fontSize: 14,
            expressions: false,
            invertedColors: true,
            advancedStyling: true,
            restrictGridToFirstQuadrant: true,
            xAxisLabel: "Level",
            yAxisLabel: "XP Required",
            backgroundColor: "#202020",
        }

        let desmosBounds = {
            left: 0,
            bottom: 0,
            right: 50,
            top: 10 ** 5.5
        }

        // failsafe in case the desmos api breaks
        let desmosGraph = typeof Desmos != "undefined" ? Desmos.GraphingCalculator(document.getElementById('xpGraph'), desmosConfig) : null
        if (desmosGraph) {
            desmosGraph.setMathBounds(desmosBounds)
            desmosGraph.setDefaultState(desmosGraph.getState())
        }
        else $('#desmosJumpscare').removeAttr("style").text("Úgy tűnik, a Desmos betöltése sikertelen ¯\\_(ツ)_/¯")

        $('.serverName').text(data.guild.name)
        $('.serverMembers').text(commafy(data.guild.members || "?") + " tag" + (data.guild.members == 1 ? "" : "ok"))
        $('.serverIcon').attr('src', data.guild.icon || "/assets/avatar.png")
        $('#otherServers').append(data.ownedServers.map(x => `<option value="${x.id}">${x.name}</option>`))
        
        // fill in inputs with current values
        $('input[db], select[db]').each(function() {
            let dbKey = $(this).attr('db').split('.')
            let dbVal = db
            while (dbKey.length) dbVal = dbVal[dbKey.shift()]
            if ($(this).attr('type') == "checkbox") $(this).prop("checked", $(this).attr("invert") ? !dbVal : dbVal)
            else $(this).val(dbVal || dbVal === 0 ? dbVal : $(this).attr('default'))
        })
        
        // number placeholders, show range
        $('input[type="number"][min][max]').each(function() {
            if (!$(this).attr("placeholder")) $(this).attr("placeholder", `${$(this).attr("min")} - ${$(this).attr("max")}`)
        })

        // fill in curve table
        let curvePreviewNumbers = [1, 2, 3, 4, 5, 7, 10, 25, 50, 100, 200]
        buildCurveTable($('#curvePreview'), curvePreviewNumbers, db.curve, db.rounding, db.gain.min, db.gain.max, db.gain.time)
        displayCurveDifficulty(db.curve, $('#scaleDifficulty'))

        // swap min and max if max is lower
        function checkMinMax() {
            let max = +$('#num_max').val()
            let min = +$('#num_min').val()
            if (min > max) {
                $('#num_min').val(max)
                $('#num_max').val(min)
            }
        }

        // update curve on change
        $('input[updatecurve]').blur(function() {
            checkMinMax()
            updateCurveTable()
        })

        // update cooldown time on change
        $('#num_time').on("input change blur", function() {
            let val = Number($(this).val())
            if (val >= 60) {
                $('#cooldownunit').text(`(${timeStr(val * 1000, 1)})`)
                $('#cooldownunit').show()
            }   
            else $('#cooldownunit').hide()
        })
        $('#num_time').trigger('change')

        // curve presets
        let presets = data.curvePresets.presets
        presets.unshift({
            "name": data.guild.name,
            "desc": "The custom settings that your server currently uses.",
            "curve": db.curve,
            "round": db.rounding,
            "bestRange": [db.gain.min, db.gain.max]
        })

        presets.forEach(x => {
            $('#curvePresets').append(`<option value="${x.name}">${x.name}</option>`)
        })

        let foundPreset = presets.find(x => x.name != data.guild.name && JSON.stringify([x.curve, x.round, x.bestRange]) == JSON.stringify([db.curve, db.rounding, [db.gain.min, db.gain.max]])) || presets[0]
        $("#curvePresets").val(foundPreset.name)

        // on curve preset selection
        $('#curvePresets').change(function() {
            let newVal = $(this).val()
            let foundPreset = presets.find(x => x.name == newVal) || presets[0]
            $('#presetDesc').html(foundPreset.desc)
            $('#presetCurve').html(`${+foundPreset.curve[3].toFixed(4)}x<sup>3</sup> + ${+foundPreset.curve[2].toFixed(4)}x<sup>2</sup> + ${+foundPreset.curve[1].toFixed(4)}x`)
            $('#presetRound').html(foundPreset.round)
            $('#presetXP').html(foundPreset.bestRange.join(" - "))
            displayCurveDifficulty(foundPreset.curve, $('#presetDifficulty'))
        })
        $('#curvePresets').trigger('change') // default preset

        // on preset apply
        $('#applyPreset').click(function() {
            let foundPreset = presets.find(x => x.name == $('#curvePresets').val())
            if (!foundPreset) return
            $("#num_round").val(foundPreset.round)
            $("#num_min").val(foundPreset.bestRange[0])
            $("#num_max").val(foundPreset.bestRange[1])
            $("#num_curve1").val(foundPreset.curve[1])
            $("#num_curve2").val(foundPreset.curve[2])
            $("#num_curve3").val(foundPreset.curve[3])
            $("#curveStuff")[0].scrollIntoView()
            updateCurveTable()
            checkUnsavedChanges()
        })

        // xp curve table update
        function updateCurveTable() {
            let newCurve = { 3: +$('#num_curve3').val(), 2: +$('#num_curve2').val(), 1: +$('#num_curve1').val() }
            if (!newCurve[3] && !newCurve[2] && !newCurve[1]) {
                $('#num_curve1').val(1)
                newCurve[1] = 1
            }

            let tableArgs = [newCurve, +$("#num_round").val(), +$("#num_min").val(), +$("#num_max").val(), +$("#num_time").val()]

            buildCurveTable($('#curvePreview'), curvePreviewNumbers, ...tableArgs)
            if ($('#fullPreviewSection').is(":visible")) buildCurveTable($('#fullCurvePreview'), 500, ...tableArgs, true)
            displayCurveDifficulty(newCurve, $('#scaleDifficulty'))
        }

        // expanded curve table
        $('#showMoreCurveInfo').click(function() {
            let isVisible = $('#fullPreviewSection').toggle()
            if ($('#fullPreviewSection').is(":visible")) updateCurveTable()
        })

        // xp curve table
        function buildCurveTable(element, levels, curve={}, rounding=100, min=50, max=100, time=60, extra) {
            if (!Array.isArray(levels)) {
                let maxLevel = parseInt(levels) || 1000
                levels = []
                for (let i=1; i <= maxLevel; i++) levels.push(i)
            }

            let columns = [
                {name: "Level", id: "level"},
                {name: "XP", id: "xp", extra: true},
                {name: "Messages", id: "msgs", extra: true},
                {name: "Cooldown Time", id: "time", extra: true},
                {name: "Total XP", id: "cum_xp"},
                {name: "Total Messages", id: "cum_msgs"},
                {name: "Total Cooldown", id: "cum_time"}
            ]

            if (!extra) columns = columns.filter(x => !x.extra)

            element.empty();
            element.append(columns.map(x => `<div col="${x.id}"><p><b>${x.name}</b></p></div>`))
            
            levels.forEach(lvl => {

                let xpRequired = getXPForLevel(lvl, curve, rounding)
                let previousRequired = getXPForLevel(lvl - 1, curve, rounding)
                let relativeRequired = Math.round(xpRequired - previousRequired)

                let msgsRequired = getAvgMessagesRequired(min, max, relativeRequired)
                let cumMsgsRequired = getAvgMessagesRequired(min, max, xpRequired)

                let totalTime = msgsRequired * time
                let cumTime = cumMsgsRequired * time
                let apx = min == max ? "" : "~ "

                columns.forEach(col => {

                    let column = element.find(`div[col=${col.id}]`)
                    let val = 0

                    switch(col.id) {
                        case "level": val = commafy(lvl); break;
                        case "xp": val = "+ " + commafy(relativeRequired); break;
                        case "msgs": val = apx + commafy(msgsRequired); break;
                        case "time": val = apx + timeStr(totalTime * 1000, 1, false, true); break;
                        case "cum_xp": val = commafy(xpRequired); break;
                        case "cum_msgs": val = apx + commafy(cumMsgsRequired); break;
                        case "cum_time": val = apx + timeStr(cumTime * 1000, 1, false, true)
                    }
                    column.append(`<p>${val}</p>`)
                })
            })

            if (desmosGraph) {
                desmosGraph.setExpression({ id: 'xp', color: "#0080FF", latex: `y = ${curve[3]}x^3 + ${curve[2]}x^2 + ${curve[1]}x \\{x>=0\\}` })
                // desmosGraph.setExpression({ id: 'required', color: "#FF0080", latex: `y = ${curve[3] * 3}x^2 + ${curve[2] * 2}x + ${curve[1]} \\{x>=0\\}` })
            }

            let curveDiff = getCurveDifficulty(curve)
            element.attr("difficulty", curveDiff)
            return curveDiff
        }

        // home tab
        let categorySlot = $('.categoryBox').clone()
        $('.categoryBox').remove()
        $('.category').each(function(index) {
            if (index == 0 || $(this).hasClass("unlisted")) return
            let cSlot = categorySlot.clone()
            cSlot.find('h2[cat=name]').text($(this).find('p').text())
            cSlot.find('p[cat=info]').text($(this).attr('title'))
            cSlot.find('img[cat=icon]').attr("src", $(this).find('img').attr('src'))
            cSlot.find('p[cat=extra]').attr("category", $(this).attr('category'))
            cSlot.addClass('categoryShortcut').attr('category', $(this).attr('category'))
            $('#serverInfo').append(cSlot)
        })
        
        // on category change
        $('.category').on("click keydown", function(e) {
            if (ignoreTabPress(e)) return
            $('.current').removeClass('current')
            $(this).addClass('current')
            $('.configboxes').hide()
            $(`.configboxes[tab="${$(this).attr('category')}"]`).show()
            $('.hideOnLoad').hide()
        })
        $('.category[category="server"]').trigger('click') // default category

        $('.categoryShortcut').on("click keydown", function(e) {
            if (ignoreTabPress(e)) return
            $(`.category[category="${$(this).attr('category')}"]`).trigger('click')
        })

        // extra info on home
        updateHomeInfo = function(data) {
            $('p[cat="extra"][category="xp"]').text(data.enabled ? `Enabled! ${commafy(data["gain.min"])}${data["gain.min"] == data["gain.max"] ? "" : `-${commafy(data["gain.max"])}`} XP every ${commafy(data["gain.time"])}s` : "XP disabled!").css("color", data.enabled ? "var(--polarisgreen)" : "#ff6666")
            $('p[cat="extra"][category="rewardroles"]').text(data.rewards.length ? addS(data.rewards.length, "reward role") : "No reward roles")
            $('p[cat="extra"][category="levelup"]').text(data["levelUp.enabled"] && data["levelUp.message"] ? `Enabled!${data["levelUp.embed"] ? " (embedded)" : ""}` : "Disabled")
            $('p[cat="extra"][category="multipliers"]').text(`${addS(data["multipliers.roles"].length, "role")}, ${addS(data["multipliers.channels"].length, "channel")}`)
            $('p[cat="extra"][category="rankcard"]').text(`${data["rankCard.disabled"] ? "Disabled" : data["rankCard.ephemeral"] ? "Láthatatlan" : "Engedélyezve!"}`)
            $('p[cat="extra"][category="leaderboard"]').text(`${data["leaderboard.disabled"] ? "Disabled" : data["leaderboard.private"] ? "Privát" : "Engedélyezve!"}${data["leaderboard.maxEntries"] ? ` (max ${commafy(data["leaderboard.maxEntries"])})` : ""}`)
            $('p[cat="extra"][category="data"]').text(`Last saved: ${lastUpdated ? `${new Date(lastUpdated).toLocaleString([], {year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'})}` : "Soha"}`)
            $('#mainlbbutton').toggle(!data['leaderboard.disabled'])
        }

        // multipliers
        let roleMultipliers = db.multipliers.roles
        let channelMultipliers = db.multipliers.channels

        // reward role table
        let rewards = db.rewards
        rewards.forEach(x => { if (!x.noSync) x.noSync = false }) // undefined -> false

        function buildRewardTable() {
            let excludeEnabled = $('#excludeRewardToggle').prop('checked')
            rewards = rewards.sort((a, b) => a.level - b.level)
            $('#rewards').html(`
                <div col="lvl" style="width: 100px"><p><b>Level</b></p></div>
                <div col="role" style="width: 400px"><p><b>Role</b></p></div>
                <div col="keep" style="width: 100px"><p><b>Keep</b></p></div>
                <div col="exclude" style="width: 100px${!excludeEnabled ? "; display: none" : ""}"><p><b>Sync</b></p></div>
                <div col="delete" style="width: 80px"><p><b>Delete</b></p></div>
            `)

            rewards.forEach(reward => {
                let foundRole = data.roles.find(x => x.id == reward.id)
                if (!foundRole) return
                else $(`#rewardRoleSelect option[value=${reward.id}]`).prop('hidden', true)

                $('#rewards div[col="lvl"]').append(`<p class="rewardLevel numberinput" tabindex="-1" roleID="${reward.id}" min="1" max="1000" default="10" contenteditable>${reward.level}</p>`)
                $('#rewards div[col="role"]').append(`<p class="longname" style="color: ${foundRole.color == "#000000" ? "var(--defaultrolecol)" : foundRole.color}">${foundRole.name}</p>`)
                $('#rewards div[col="keep"]').append(`<p class="toggleRow" tr="keep" tabindex="0" roleID="${reward.id}" style="color: ${reward.keep ? "lime" : "nah"}">${reward.keep ? "Yes" : "No"}${reward.noSync && !excludeEnabled ? "*" : ""}</p>`)
                $('#rewards div[col="exclude"]').append(`<p class="toggleRow" tr="noSync" tabindex="0" roleID="${reward.id}" style="color: ${reward.noSync ? "red" : "lime"}">${reward.noSync ? "No" : "Yes"}</p>`)
                $('#rewards div[col="delete"]').append(`<p class="deleteRow deleteReward" tabindex="0" roleID="${reward.id}">🗑️</p>`)
            })
            $('#rewardCount').html(rewards.length)
            checkUnsavedChanges()
        }

        // role selector appending (hacky but whatever, screw frontend stuff)
        function appendRoleSelect(element, roleOption, role, onlyGrantable, hideCondition) {
            let option = roleOption.clone()
            let roleSelect = $(element)
            if (hideCondition) option.prop("hidden", true)
            if (!roleSelect.children().length) roleSelect.append("<option value='none' selected disabled>(role)</option>")

            if (onlyGrantable && !role.grantable) {
                if (option.val() == data.guild.id) return
                option.css("color", "")
                option.prop("disabled", true)
                option.html(option.html() + " -- too high to grant!")
            }

            return roleSelect.append(option)
        }

        // role selectors
        data.roles.forEach(x => {
            let roleOption = $(`<option value="${x.id}">${x.name}</option>`)
            roleOption.css("color", x.color == "#000000" ? "var(--defaultrolecol)" : x.color)

            if (!x.managed) appendRoleSelect('#rewardRoleSelect', roleOption, x, true, rewards.some(r => r.id == x.id))
            appendRoleSelect('#roleMultiplierSelect', roleOption, x, false, roleMultipliers.some(r => r.id == x.id))
        })

        let channelPrefixes = { channel: "#", category: "&gt; ", vc: "🔊 ", thread: "└─ ", forum: "💬 "}
        let chMultiplierChannels = data.channels.map(x => `<option ${x.type == "category" ? `style="font-weight: bold"` : ""} value="${x.id}">${channelPrefixes[x.type] || "* "}${x.name}</option>`)
        $('#channelMultiplierSelect').append("<option value='none' selected disabled>(channel)</option>").append(chMultiplierChannels)


        // add new reward role
        $('#addRewardRole').click(function() {
            let roleID = $('#rewardRoleSelect').val()
            let level = Math.round($('#rewardLevel').val())
            let keep = !$('#rewardKeep').prop('checked')
            let noSync = $('#rewardExclude').prop('checked')

            if (!data.roles.some(x => x.id == roleID) || rewards.some(x => x.id == roleID) || !level || level <= 0 || level > 1000) return
            else rewards.push({ id: roleID, level, keep, noSync })
            $('#rewardRoleSelect').val("none")
            buildRewardTable()
        })

        $('#rewardRoleSelect').change(function() {
            let selected = $(this).find(":selected").text()
            let foundNumber = selected.match(/[0-9.]+/)
            if (foundNumber && !foundNumber[0].includes(".")) {
                let num = Number(foundNumber[0])
                if (num > 0 && num <= 1000) $('#rewardLevel').val(num)
            }
        })

        // reward role - swap keep
        $(document).on('click keydown', '.toggleRow', function(e) {
            if (ignoreTabPress(e)) return
            let tr = $(this).attr("tr")
            let foundReward = rewards.find(x => x.id == $(this).attr("roleID"))
            if (foundReward) foundReward[tr] = !foundReward[tr]
            buildRewardTable()
        })

        // reward role - delete
        $(document).on('click keydown', '.deleteReward', function(e) {
            if (ignoreTabPress(e)) return
            let foundReward = rewards.find(x => x.id == $(this).attr("roleID"))
            if (foundReward) rewards = rewards.filter(x => x.id != foundReward.id)
            $(`#rewardRoleSelect option[value=${foundReward.id}]`).prop('hidden', false)
            buildRewardTable()
        })

        // reward role - edit level
        $(document).on('blur', '.rewardLevel', function() {
            let foundReward = rewards.find(x => x.id == $(this).attr("roleID"))
            if (!foundReward) return
            let newVal = Math.round($(this).text())
            if (newVal != foundReward.level && newVal > 0 && newVal <= 1000) foundReward.level = newVal
            buildRewardTable()
        })

        // reward role - toggle excuded
        $('#excludeRewardToggle').click(function() {
            let checked = $(this).prop('checked')
            window.scrollTo({top: 0, behavior: 'smooth'});
            if (checked) $('.excludeMode').show()
            else $('.excludeMode').hide()
            buildRewardTable()
        })
        if (rewards.some(x => x.noSync)) $('#excludeRewardToggle').prop('checked', true)
        else $('.excludeMode').hide()

        // show curve difficulty
        function displayCurveDifficulty(curve, difficultyText) {
            let diffRating = Number(getCurveDifficulty(curve).toFixed(2))
            let ratingKeys = Object.entries(data.curvePresets.difficultyRatings).reverse()
            return difficultyText.text(`${commafy(diffRating)} (${ratingKeys.find(x => +x[0] <= diffRating)[1]})`)
        }

        // multiplier role table
        function buildRoleMultiplerTable() {
            roleMultipliers = roleMultipliers.sort((a, b) => a.boost - b.boost)
            $('#roleMultipliers').html(`
                <div col="boost" style="width: 140px"><p><b>Multiplier</b></p></div>
                <div col="role" style="width: 380px"><p><b>Role</b></p></div>
                <div col="delete" style="width: 80px"><p><b>Delete</b></p></div>
            `)

            roleMultipliers.forEach(boost => {
                let foundRole = data.roles.find(x => x.id == boost.id)
                if (!foundRole) return
                else $(`#roleMultiplierSelect option[value=${boost.id}]`).prop('hidden', true)

                $('#roleMultipliers div[col="boost"]').append(`<p class="roleMultiplierAmount numberinput" roleID="${boost.id}" min="0" max="100" decimals="4" default="1" tabindex="-1" contenteditable>${+boost.boost}x</p>`)
                $('#roleMultipliers div[col="role"]').append(`<p class="longname" style="color: ${foundRole.color == "#000000" ? "var(--defaultrolecol)" : foundRole.color}">${foundRole.name}</p>`)
                $('#roleMultipliers div[col="delete"]').append(`<p class="deleteRow deleteRoleMultiplier" tabindex="0" roleID="${boost.id}">🗑️</p>`)
            })
            $('#roleMultiplierCount').html(roleMultipliers.length)
            checkUnsavedChanges()
        }

        // add new multiplier role
        $('#addRoleMultiplier').click(function() {
            let roleID = $('#roleMultiplierSelect').val()
            let boost = Number(Number($('#roleMultiplierAmount').val()).toFixed(2))

            if (isNaN(boost) || !$('#roleMultiplierAmount').val() || !data.roles.some(x => x.id == roleID) || roleMultipliers.some(x => x.id == roleID) || boost < 0 || boost > 100) return
            else roleMultipliers.push({ id: roleID, boost: boost })
            $('#roleMultiplierSelect').val("none")
            buildRoleMultiplerTable()
        })

        // multiplier role - delete
        $(document).on('click keydown', '.deleteRoleMultiplier', function(e) {
            if (ignoreTabPress(e)) return
            let foundReward = roleMultipliers.find(x => x.id == $(this).attr("roleID"))
            if (foundReward) roleMultipliers = roleMultipliers.filter(x => x.id != foundReward.id)
            $(`#roleMultiplierSelect option[value=${foundReward.id}]`).prop('hidden', false)
            buildRoleMultiplerTable()
        })
        
        // multiplier role - edit amount
            $(document).on('blur', '.roleMultiplierAmount', function() {
            let foundMultiplier = roleMultipliers.find(x => x.id == $(this).attr("roleID"))
            let newBoost = Number(Number($(this).text()).toFixed(2))
            if (foundMultiplier && !isNaN(newBoost) && newBoost >= 0 && newBoost <= 100) foundMultiplier.boost = newBoost
            buildRoleMultiplerTable()
        })

        // multiplier s - remove X when editing amount
                $(document).on('focus', '.roleMultiplierAmount, .channelMultiplierAmount', function() {
            $(this).html($(this).html().replace("x", ""))
        })


        // welcome to downtown copypasteville
        // multiplier channel table
        function buildChannelMultiplierTable() {
            channelMultipliers = channelMultipliers.filter(x => data.channels.some(c => c.id == x.id))
            .sort((a, b) => data.channels.findIndex(c => c.id == a.id) - data.channels.findIndex(c => c.id == b.id))

            $('#channelMultipliers').html(`
                <div col="boost" style="width: 140px"><p><b>Multiplier</b></p></div>
                <div col="channel" style="width: 380px"><p><b>Channel</b></p></div>
                <div col="delete" style="width: 80px"><p><b>Delete</b></p></div>
            `)

            channelMultipliers.forEach(boost => {
                let foundChannel = data.channels.find(x => x.id == boost.id)
                if (!foundChannel) return
                else $(`#channelMultiplierSelect option[value=${boost.id}]`).prop('hidden', true)

                $('#channelMultipliers div[col="boost"]').append(`<p class="channelMultiplierAmount numberinput" channelID="${boost.id}" min="0" max="100" decimals="4" default="1" tabindex="-1" contenteditable>${+boost.boost}x</p>`)
                $('#channelMultipliers div[col="channel"]').append(`<p class="longname">${channelPrefixes[foundChannel.type] || "* "}${foundChannel.name}</p>`)
                $('#channelMultipliers div[col="delete"]').append(`<p class="deleteRow deleteChannelMultiplier" tabindex="0" channelID="${boost.id}">🗑️</p>`)
            })
            $('#channelMultiplierCount').html(channelMultipliers.length)
            checkUnsavedChanges()
        }

        // add new multiplier channel
        $('#addChannelMultiplier').click(function() {
            let channelID = $('#channelMultiplierSelect').val()
            let boost = Number(Number($('#channelMultiplierAmount').val()).toFixed(2))

            if (isNaN(boost) || !$('#channelMultiplierAmount').val() || !data.channels.some(x => x.id == channelID) || channelMultipliers.some(x => x.id == channelID) || boost < 0 || boost > 100) return
            else channelMultipliers.push({ id: channelID, boost: boost })
            $('#channelMultiplierSelect').val("none")
            buildChannelMultiplierTable()
        })

        // multiplier channel - delete
        $(document).on('click', '.deleteChannelMultiplier', function() {
            let foundReward = channelMultipliers.find(x => x.id == $(this).attr("channelID"))
            if (foundReward) channelMultipliers = channelMultipliers.filter(x => x.id != foundReward.id)
            $(`#channelMultiplierSelect option[value=${foundReward.id}]`).prop('hidden', false)
            buildChannelMultiplierTable()
        })
        
        // multiplier channel - edit amount
            $(document).on('blur', '.channelMultiplierAmount', function() {
            let foundMultiplier = channelMultipliers.find(x => x.id == $(this).attr("channelID"))
            let newBoost = Number(Number($(this).text()).toFixed(2))
            if (foundMultiplier && !isNaN(newBoost) && newBoost >= 0 && newBoost <= 100) foundMultiplier.boost = newBoost
            buildChannelMultiplierTable()
        })


        // level up message channel
        $("#lvlMessageSelect").append(data.channels.filter(x => x.type == "channel").map(x => `<option value="${x.id}">#${x.name}</option>`))
        $("#lvlMessageSelect").val(db.levelUp.channel)
        if (!$("#lvlMessageSelect").val()) $("#lvlMessageSelect").val("current")

        if (!db.levelUp.enabled) $('.ifmessageenabled').hide()
        if (db.leaderboard.disabled) $('.iflbenabled').hide()
        if (db.rankCard.disabled) $('.ifrankenabled').hide()

        if (db.levelUp.embed) {
            $('#regularMessage').hide()
            $('#embedMessage').show()
            $('#lvlUpMessage').addClass('inactiveSave')
            $('#lvlUpEmbed').removeClass('inactiveSave')
            $('#lvlUpEmbed').text(db.levelUp.message)
        }

        else {
            $('#regularMessage').show()
            $('#embedMessage').hide()
            $('#lvlUpEmbed').addClass('inactiveSave')
            $('#lvlUpMessage').removeClass('inactiveSave')
            $('#lvlUpMessage').text(db.levelUp.message)
        }

        $('#toggleLvlUpEmbed').click(function() {
            $('#regularMessage').toggle()
            $('#embedMessage').toggle()
            $('#lvlUpMessage, #lvlUpEmbed').toggleClass('inactiveSave')
        })

        $('#lvlUpEmbed').on("change blur", function() {
            if ($(this).val().trim().length < 1) {
                $(this).val("")
                return $('#invalidLevelUpEmbed').hide()
            }
            else if (validateEmbedJSON()) $('#invalidLevelUpEmbed').hide()
            else $('#invalidLevelUpEmbed').show()
        })

        $('#lvlUpMessageVariables select').change(function() {
            let text = $(this).val()
            let textbox = $('.lvlTextbox:visible')
            $(this).val("x")
            if (!textbox.length) return

            let cursor = textbox[0].selectionStart;
            textbox.val(textbox.val().slice(0, cursor) + text + textbox.val().slice(cursor))
            textbox.focus();
            textbox[0].selectionStart = textbox[0].selectionEnd = cursor + text.length; 
        })

        $('.multiplierSelect').change(function() {
            let mType = $(this).attr('desc')
            let desc = multiplierDescriptions[mType][$(this).val()] || "Hiba! Kérjük, próbálja újra."
            $(`#${mType}MultiplierDescription`).text(desc)
        })
        $('.multiplierSelect').trigger('change')

        $('.colInputPreview').on("click keydown", function(e) {
            if (ignoreTabPress(e)) return
            $(`#${$(this).attr("for")}`).trigger("click")
        })

        $('.previewColorInput').on("input blur", function() {
            let id = $(this).attr("id")
            $(`.colInputPreview[for="${id}"]`).css("background-color", $(this).val())
            $(`.colorInput[for="${id}"]`).val($(this).val())
        })

        $('.colorInput').on("input blur", function(e) {
            let colFor = $(this).attr("for")
            let val = $(this).val().replace("#", "")
            if (val.match(/^[0-9a-fA-F]{6}$/)) {
                $(`#${colFor}`).val("#" + val)
                $(`.colInputPreview[for="${colFor}"]`).css("background-color", "#" + val)
            }
            if (e.type == "blur") { $(`#${colFor}`).trigger("blur"); checkUnsavedChanges() }
        })

        function toggleEmbedColorDiv(val, name, slider) {
            if (val == -1) return
            $(`#${slider}`).prop("checked", true)
            $(`#${name}Config`).show()
            $(`#${name}`).val("#" + val.toString(16)).trigger("input")
        }

        toggleEmbedColorDiv(db.rankCard.embedColor, "customEmbedColRank", "useCustomEmbedColRank")
        toggleEmbedColorDiv(db.leaderboard.embedColor, "customEmbedColTop", "useCustomEmbedColTop")
        
        $('.leaderboardLink').attr("href", "/leaderboard/" + data.guild.id)

        if (data.guild.botDev) $('.forDevs').removeAttr('disabled')

        generateSaveJSON = function() {
            let settings = { rewards, "multipliers.roles": roleMultipliers, "multipliers.channels": channelMultipliers }

            $("[saveName]:not(.inactiveSave)").each(function() {
                let x = $(this)
                let node = x.prop("nodeName")
                let property = x.attr("saveName")
                if (property == "db") property = x.attr("db")
                let val = x.val()

                switch(node) {

                    case "INPUT": case "TEXTAREA":
                        let aType = x.attr("type")
                        if (aType == "number") settings[property] = +val
                        else if (aType == "checkbox") settings[property] = x.attr("invert") ? !x.prop("checked") : x.prop("checked")
                        else if (aType == "color") {
                            if (x.attr("useif") && !$('#' + x.attr("useif")).prop("checked")) settings[property] = -1
                            else settings[property] = parseInt(val.replace("#", ""), 16)
                        }
                        else settings[property] = val
                        break

                    default:
                        settings[property] = val
                        
                }
            })

            return settings
    }

    buildRewardTable()
    buildRoleMultiplerTable()
    buildChannelMultiplierTable()

    let defaultData = generateSaveJSON()
    updateHomeInfo(defaultData)
    lastSavedData = JSON.stringify(defaultData)

    $('#everything').show()
    $('#loading').hide()

    }).catch((e) => {
        console.error(e)
        $('#errorheader').css('margin-top', '70px')
        if (e.apiError) switch (e.code) {
            case "noPerms":
                $('#errorheader').text("Nincsen jogod!")
                $('#errorfooter').text("Nincsen jogosultságod a szerverkezeléséhez.")
                break;

            case "login":
                $('#errorheader').text("Nem vagy bejelentkezve!")
                $('#errorfooter').text("Kérjük, jelentkezz be a szerver kezeléséhez.")
                $('#loginbutton').show()
                break;

            default:
                $('#errorfooter').text(e.message)
                break;
        }

        else {
            $('#errorfooter').text(e.message)
            $('#errorhelp').show()
        }
        
        $('#loading').hide()
        $('#uhoh').show()
    })

    let lastSavedData;

    // need these to be global, excellent programming i know
    let generateSaveJSON = function() { return {} }
    let updateHomeInfo = function() { return {} }

    function addS(amount, str) {
        return `${commafy(amount)} ${str}${amount == 1 ? "" : "s"}`
    }

    this.commafy = function(num, locale="hu") {
            return num.toLocaleString(locale, { maximumFractionDigits: 10 })
        }

    function commafy(num, locale="hu") {
        return num.toLocaleString(locale, { maximumFractionDigits: 10 })
    }

    function getXPForLevel(level, curve, rounding) {
        let xpRequired = Object.entries(curve).reduce((total, n) => total + (n[1] * (level ** n[0])), 0)
        return rounding > 1 ? rounding * Math.round(xpRequired / rounding) : xpRequired
    }

    function getAvgMessagesRequired(min, max, xp) {
        return Math.round([min, max].map(x => xp / x).reduce((a, b) => a + b, 0) / 2)
    }

    function getCurveDifficulty(curve, levelTest=75) {
        let second_derivative = (6 * curve[3] * levelTest) + (2 * curve[2])
        return second_derivative
    }

    // for focused elements - ignore unless pressing space or enter
    function ignoreTabPress(e) {
        return (e.type == "keydown" && ![32, 13].includes(e.keyCode))
    }

    // check if unsaved changes were made
    function hasUnsavedChanges() { 
        return lastSavedData != JSON.stringify(generateSaveJSON())
    }

    // generate save json but only the values that actually changed
    function compareSaveJSON() {
        let lastSaved = JSON.parse(lastSavedData)
        let currentSaved = generateSaveJSON()
        let diff = {}
        Object.keys(currentSaved).forEach(k => {
            if (JSON.stringify(currentSaved[k]) != JSON.stringify(lastSaved[k])) diff[k] = currentSaved[k]
        })
        return diff
    }

    // show popup if there's unsaved changes
    function checkUnsavedChanges() {
        if (!lastSavedData) return
        if (hasUnsavedChanges()) $('#unsavedWarning').addClass('activeWarning')
        else $('#unsavedWarning').removeClass('activeWarning')
    }

    function validateEmbedJSON() {
        try { 
            let jsonTest = JSON.parse($('#lvlUpEmbed').val()).embeds[0]
            if (Array.isArray(jsonTest) || typeof jsonTest != "object") return false
            else return true
        }
        catch(e) { return false }
    }

    $('[saveName]').change(checkUnsavedChanges)

    $(document).on("input blur", 'input[type=number], .numberinput', function(e) {
        
        let isInput = e.target.nodeName == "INPUT"
        let rawVal = isInput ? $(this).val() : $(this).text()
        let val = Number(rawVal)
        let min = Number($(this).attr('min'))
        let max = Number($(this).attr('max'))
        let dec = Number($(this).attr('decimals') || 0)
        let def = Number($(this).attr('default'))
        let cleanVal = val

        if (!rawVal.length) cleanVal = isNaN(def) ? "" : def
        else if (!isNaN(min) && val < min) cleanVal = min
        else if (!isNaN(max) && val > max) cleanVal = max 

        if (e.type == "input" && cleanVal != val) $(this).addClass('red')
        else $(this).removeClass('red')

        if (e.type != "input") {
            if (isNaN(def) && cleanVal === "") return
            let rounded = +cleanVal.toFixed(dec)
            isInput ? $(this).val(rounded) : $(this).text(rounded)
        }
    })

    $(document).on("input blur", 'input[type=checkbox][linked]', function(e) {
        let link = $(this).attr('linked')
        let checked = $(this).prop('checked')
        $(`input[type=checkbox][linked=${link}]`).prop('checked', false)
        if (checked) $(this).prop('checked', true)
    })


    let requestInProgress = false

    $('#saveChanges').click(function() {
        if (requestInProgress || $('#unsavedWarning.activeWarning').length < 1) return
        let lvlEmbedEnabled = $('#toggleLvlUpEmbed').prop('checked')
        if (lvlEmbedEnabled && !validateEmbedJSON()) return alert("Érvénytelen szintlépés üzenet beágyazása! Kérjük, javítsa vagy távolítsa el előtt a mentést.")
        else requestInProgress = true
        $('#saveChanges').html("...")
        let savejson = compareSaveJSON()
        if (savejson["levelUp.message"] && !savejson["levelUp.embed"]) savejson["levelUp.embed"] = lvlEmbedEnabled
        $.ajax({
            url: "/api/settings", type: "post",
            data: JSON.stringify(Object.assign(savejson, {guildID})),
            headers: { 'Content-Type': 'application/json'}
        })
        .done(function(res) {
            requestInProgress = false
            $('#saveChanges').html("Save")
            let newSave = generateSaveJSON()
            lastUpdated = Date.now()
            updateHomeInfo(newSave)
            lastSavedData = JSON.stringify(newSave)
            $('#unsavedWarning').removeClass('activeWarning')
        })
        .fail(function (e) {
            requestInProgress = false
            $('#saveChanges').html("Save")
            alert(`Hiba! ${e.responseText}`);
            console.error(e)
        })
    })

    $('#resetSettings').click(function() {
        if (requestInProgress) return
        else if (!confirm("Ez tényleg az utolsó esélyed! Biztosan szeretnéd visszaállítani az összes beállítást?")) return
        requestInProgress = true
        $.ajax({
            url: "/api/settings", type: "post",
            data: JSON.stringify({guildID, resetSettings: true}),
            headers: { 'Content-Type': 'application/json'}
        })
        .done(function(res) {
            requestInProgress = false
            window.location.reload()
        })
        .fail(function (e) {
            requestInProgress = false
            alert(`Hiba! ${e.responseText}`);
            console.error(e)
        })
    })

    $('#resetXP').click(function() {
        if (requestInProgress) return
        else if (!confirm("Ez tényleg az utolsó esélyed!!! Állítsd vissza mindenki XP-jét!?")) return
        requestInProgress = true
        $.ajax({
            url: "/api/settings", type: "post",
            data: JSON.stringify({guildID, resetXP: true}),
            headers: { 'Content-Type': 'application/json'}
        })
        .done(function(res) {
            requestInProgress = false
            alert("Az összes XP visszaállítva!")
            $('.confirmReset').hide()
            $('.confirmConfirmReset').hide()
        })
        .fail(function (e) {
            requestInProgress = false
            alert(`Hiba! ${e.responseText}`);
            console.error(e)
        })
    })

    $('.exportXP').click(function() {
        if (requestInProgress) return
        else requestInProgress = true
        let format = $(this).attr("format")

        fetch(`/api/xp/${guildID}?format=${format}`).then(res => {
            if (!res.ok) {
                requestInProgress = false
                return res.json().then(e => { alert(`Hiba! ${e.message}`); }).catch(() => { alert("Hiba!") })
            }
            requestInProgress = false
            res.blob().then(blob => {
                let downloader = document.createElement('a');
                downloader.href = URL.createObjectURL(blob)
                downloader.dataset.downloadurl = ['text/txt', downloader.download, downloader.href].join(':');
                downloader.style.display = "none"; downloader.download = `${serverName}.${format == "everything" ? "json" : format}`
                downloader.target = "_blank"; document.body.appendChild(downloader);
                downloader.click(); document.body.removeChild(downloader);
            })
        }).catch((e) => {
            requestInProgress = false
            alert(`Error! ${e.responseText}`);
            console.error(e)
        })
    })

    $('#sendExample').click(function() {
        if (requestInProgress) return

        let exampleLevel = Number($('#exampleLevel').val())
        let saveData = generateSaveJSON()
        let embedMode = saveData['levelUp.embed']
        if (embedMode && !validateEmbedJSON()) return alert("Érvénytelen szintlépés üzenet beágyazása! Kérjük, javítsa vagy távolítsa el előtt a tesztelést.")
        else if (!saveData['levelUp.message']) return
        else requestInProgress = true
        
        $('.exampleP').hide()
        $('#sendingExample').show()

        $('#sendExample').prop('disabled', true)
        $.ajax({
            url: "/api/sendexample", type: "post",
            data: JSON.stringify({guildID, embed: embedMode, level: exampleLevel || undefined, message: saveData['levelUp.message']}),
            headers: { 'Content-Type': 'application/json'}
        })
        .done(function(res) {
            requestInProgress = false
            setTimeout(() => { $('#sendExample').prop('disabled', false) }, 3000);
            $('#sendingExample').hide()
            $('#exampleSent').show()
        })
        .fail(function (e) {
            requestInProgress = false
            setTimeout(() => { $('#sendExample').prop('disabled', false) }, 3000);
            $('#sendingExample').hide()
            $('#exampleError').show()
            console.error(e)
        })
    })

    $('#confirmPrune').click(function() {
        if (requestInProgress) return
        let amt = Number($('#prune_amt').val())
        if (amt <= 0) return

        $('#confirmPrune').prop('disabled', true)

        requestInProgress = true

        $.ajax({
            url: "/api/pruneMembers", type: "post",
            data: JSON.stringify({guildID, amount: amt}),
            headers: { 'Content-Type': 'application/json'}
        })
        .done(function(res) {
            requestInProgress = false
            setTimeout(() => { $('#confirmPrune').prop('disabled', false) }, 1000);

            if (res.matches < 1) return alert(`Senki a szervereden nincs ${amt} XP alatt!`)

            if (confirm(`Biztosan szeretnéd prunelni? Ez törli ${commafy(res.matches)} felhasználót, még ${commafy(res.total - res.matches)} marad.`)) {
                
                requestInProgress = true

                $.ajax({
                    url: "/api/pruneMembers", type: "post",
                    data: JSON.stringify({guildID, amount: amt, confirmPrune: "hell yes"}),
                    headers: { 'Content-Type': 'application/json'}
                })
                .done(function(res) {
                    requestInProgress = false
                    return alert(res)
                })
                .fail(function (e) {
                    requestInProgress = false
                    alert("Hiba történt a prune számlálás ellenőrzése közben!\n" + e.message)
                    console.error(e)
                })

            }
        })
        .fail(function (e) {
            requestInProgress = false
            setTimeout(() => { $('#confirmPrune').prop('disabled', false) }, 1000);
            alert("Hiba történt a prune számlálás ellenőrzése közben!\n" + e.message)
            console.error(e)
        })
    })

    function readJSONFile(file) {
        return new Promise((res, rej) => {
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const parsed = JSON.parse(reader.result)
                    res(parsed)
                }
                catch(e) { rej(e) }
            }
            reader.onerror = () => rej(reader.error)
            reader.readAsText(file)
        })
    }

    let failedImports = []
    $('#confirmBotImport').click(async function() {
        if (requestInProgress) return

        if (hasUnsavedChanges()) return alert("Kérlek, mentsd el az el nem mentett változtatásaidat először!")

        let botName = $('#importfrom').find(":selected").text().split("(")[0].trim()
        let importBot = $('#importfrom').val()
        let importGroup = $(`.importdiv[importtype='${importBot}']`)

        let jsonData;
        if (importBot == "json") {
            let jsonfile = $('#importJSONFile').prop('files')[0]
            if (!jsonfile) return alert("Nem .json fájl lett feltöltve!")
            jsonData = await readJSONFile(jsonfile).catch(() => null)
            if (!jsonData) return alert("Nem sikerült feldolgozni azt a fájlt! Biztos benne, hogy érvényes .json fájl?")
            if (Array.isArray(jsonData) && jsonData[0] && jsonData[0].xp && !confirm("Ez a .json fájl csak XP adatokat tartalmaz - a beállítások nem lesznek módosítva. Rendben van ez így?")) return
        }

        if (!importGroup.length) return alert("Érvénytelen bot??!")
        if (failedImports.includes(importBot)) return alert(`Már próbáltad importálni a ${botName} botból, és sikertelen volt! Kérlek, várj 30 másodpercet az utolsó próbálkozás óta, mielőtt újra megpróbálnád.`)

        let importSettings = { bot: importBot }
        importGroup.find('.importSetting').each(function() {
            importSettings[$(this).attr("option")] = $(this).attr("type") == "checkbox" ? $(this).prop("checked") : $(this).val()
        })

        if (!importSettings.xp && (!importSettings.settings && !importSettings.rewardroles)) return alert("Kérlek, importáld az XP adatokat vagy a beállításokat!")

        requestInProgress = true
        $('#botimporting').hide()
        $('#botimportloading').show()

        const importData = {guildID, import: importSettings}
        if (jsonData) importData.jsonData = jsonData

        $.ajax({
            url: "/api/importfrombot", type: "post",
            data: JSON.stringify(importData),
            headers: { 'Content-Type': 'application/json'}
        })
        .done(function(res) {
            $('#botimportloading').hide()
            alert(res)
            window.location.reload()
        })
        .fail(function (e) {
            $('#botimporting').show()
            $('#botimportloading').hide()
            requestInProgress = false
            if (e.responseJSON && e.responseJSON.apiError) {
                let isJSON = (importBot == "json")
                if (e.responseJSON.code == "noData") alert(isJSON ? "Nincs szerver vagy XP adat a fájlban!" : "Ez a szerver nem rendelkezik adattal!")
                else alert("Hiba történt az adat importálása közben!\n" + e.responseJSON.message)  
                if (e.responseJSON.code != "importCooldown" && e.responseJSON.code != "invalidImport") {
                    if (!isJSON) failedImports.push(importBot)
                    setTimeout(() => {
                        failedImports = failedImports.filter(x => x != importBot)
                    }, 30 * 1000);
                }
            }
            else {
                alert("Hiba történt az adat importálása közben!\n" + e.message)  
            }
            console.error(e)
        })
    })

</script>

</html>